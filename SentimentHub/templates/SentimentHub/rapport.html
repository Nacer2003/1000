{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport Détaillé - SentimentHub</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="{% static 'assets/css/rapport.css' %}">

    <style>
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    /* Couleurs principales */
    --primary: #2563eb;
    --primary-light: #dbeafe;
    --primary-dark: #1d4ed8;
    --success: #10b981;
    --success-light: #d1fae5;
    --danger: #ef4444;
    --danger-light: #fee2e2;
    --warning: #f59e0b;
    --warning-light: #fef3c7;

    * Couleurs neutres */
  --light-bg: #ffffff;
  --light-surface: #fafafa;
  --light-border: #e5e5e5;
  --light-text: #000000;
  --light-text-secondary: #666666;

  --dark-bg: #000000;
  --dark-surface: #1a1a1a;
  --dark-border: #333333;
  --dark-text: #ffffff;
  --dark-text-secondary: #cccccc;

    /* Espacements */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 16px;
    --space-lg: 24px;
    --space-xl: 32px;

    /* Arrondis */
    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg: 16px;
    --radius-xl: 24px;
    --radius-round: 9999px;

    /* Ombres */
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
    --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1), 0 5px 10px rgba(0, 0, 0, 0.05);

    /* Transitions */
    --transition-fast: 0.2s ease;
    --transition-normal: 0.3s ease;

    /* Variables dynamiques - par défaut thème clair */
    --bg-color: var(--light-bg);
    --surface: var(--light-surface);
    --text-color: var(--light-text);
    --text-secondary: var(--light-text-secondary);
    --border-color: var(--light-border);
}

body {
    font-family: 'Inter', sans-serif;
    background: var(--bg-color);
    color: var(--text-color);
    line-height: 1.6;
    transition: background-color 0.3s, color 0.3s;
}

/* Thème clair */
body.light-theme {
    --bg-color: var(--light-bg);
    --surface: var(--light-surface);
    --text-color: var(--light-text);
    --text-secondary: var(--light-text-secondary);
    --border-color: var(--light-border);
}

/* Thème sombre */
body.dark-theme {
    --bg-color: var(--dark-bg);
    --surface: var(--dark-surface);
    --text-color: var(--dark-text);
    --text-secondary: var(--dark-text-secondary);
    --border-color: var(--dark-border);
}

/* Assurer que tous les éléments utilisent les bonnes couleurs */
h1, h2, h3, h4, h5, h6, p, span, div, button, a, label, input, textarea, select {
    color: var(--text-color);
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.header {
    background: var(--surface);
    color: var(--text-color);
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    margin-bottom: 30px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
}

.header h1 {
    font-size: 2.5rem;
    margin-bottom: 10px;
    font-weight: 700;
    color: var(--text-color);
}

.header p {
    font-size: 1.1rem;
    opacity: 0.9;
    color: var(--text-secondary);
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.card {
    background: var(--surface);
    border-radius: 15px;
    padding: 30px;
    box-shadow: var(--shadow-md);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid var(--border-color);
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
}

.card-title {
    font-size: 1.4rem;
    font-weight: 600;
    margin-bottom: 25px;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 12px;
}

.card-title i {
    color: var(--primary);
}

.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--surface);
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    box-shadow: var(--shadow-md);
    transition: transform 0.3s ease;
    position: relative;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary);
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-icon {
    font-size: 2.5rem;
    margin-bottom: 15px;
}

.stat-value {
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 8px;
}

.stat-label {
    color: var(--text-secondary);
    font-weight: 500;
    font-size: 0.95rem;
}

.positive { color: var(--success); }
.negative { color: var(--danger); }
.neutral { color: var(--primary); }
.info { color: var(--warning); }

.chart-container {
    position: relative;
    height: 400px;
    margin: 20px 0;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: var(--surface);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
}

.data-table th {
    background: var(--bg-color);
    padding: 15px;
    text-align: left;
    font-weight: 600;
    color: var(--text-color);
    border-bottom: 1px solid var(--border-color);
}

.data-table td {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    vertical-align: top;
    color: var(--text-color);
}

.data-table tr:hover {
    background: var(--bg-color);
}

.sentiment-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--danger);
    background: #fad1d1;
}

.sentiment-badge.positif {
    background: var(--success-light);
    color: var(--success);
}

.sentiment-badge.negatif {
    background: var(--danger-light);
    color: var(--danger);
}

.sentiment-badge.neutre {
    background: #dbe5fe;
    color: #3b82f6;
}

.keywords-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.keyword-cloud {
    background: var(--bg-color);
    border-radius: 12px;
    padding: 20px;
    border-left: 4px solid;
    border: 1px solid var(--border-color);
}

.keyword-cloud.positive {
    border-left-color: var(--success);
}

.keyword-cloud.negative {
    border-left-color: var(--danger);
}

.keyword-cloud h4 {
    margin-bottom: 15px;
    font-size: 1.1rem;
    color: var(--text-color);
}

.keyword-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.keyword-tag {
    background: var(--surface);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
    box-shadow: var(--shadow-sm);
    transition: transform 0.2s ease;
    color: var(--text-color);
    border: 1px solid var(--border-color);
}

.keyword-tag:hover {
    transform: translateY(-1px);
}

.export-section {
    background: var(--surface);
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    margin-top: 30px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
}

.export-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
    margin-top: 25px;
}

.btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 10px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
}

.btn:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-secondary {
    background: var(--surface);
    color: var(--text-color);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: var(--bg-color);
    box-shadow: var(--shadow-md);
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    color: var(--primary);
    text-decoration: none;
    font-weight: 500;
    margin-top: 30px;
    transition: color 0.3s ease;
}

.back-link:hover {
    color: var(--primary-dark);
}

.error-message {
    background: var(--danger-light);
    color: var(--danger);
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    margin: 20px 0;
    border-left: 4px solid var(--danger);
}

.insights-section {
    background: var(--surface);
    border-radius: 15px;
    padding: 30px;
    margin: 30px 0;
    border-left: 4px solid var(--primary);
    border: 1px solid var(--border-color);
}

.insight-item {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background: var(--bg-color);
    border-radius: 10px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.insight-icon {
    font-size: 1.5rem;
    color: var(--primary);
    margin-top: 2px;
}

.insight-content h4 {
    margin-bottom: 5px;
    color: var(--text-color);
}

.insight-content p {
    color: var(--text-secondary);
    font-size: 0.95rem;
}

@media (max-width: 768px) {
    .container {
        padding: 15px;
    }
    
    .header {
        padding: 25px;
    }
    
    .header h1 {
        font-size: 2rem;
    }
    
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-overview {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .export-buttons {
        flex-direction: column;
        align-items: center;
    }
    
    .data-table {
        font-size: 0.9rem;
    }
    
    .data-table th,
    .data-table td {
        padding: 10px;
    }
}
    </style>
</head>
<body>
   
            <!-- Reste du contenu existant -->
    <div class="container">
        {% if error %}
        <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            {{ error }}
            <br><br>
            <a href="{% url 'upload_csv' %}" class="btn">
                <i class="fas fa-upload"></i>
                Analyser un fichier
            </a>
        </div>
        {% else %}
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Rapport d'Analyse Détaillé</h1>
            <p>Analyse complète des sentiments avec insights et visualisations avancées</p>
            {% if filename %}
            <p style="margin-top: 10px; opacity: 0.8;">
                <i class="fas fa-file"></i> {{ filename }} | 
                <i class="fas fa-calendar"></i> {{ analysis_date|date:"d/m/Y à H:i" }}
            </p>
            {% endif %}
        </div>

        <!-- Vue d'ensemble des statistiques -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-icon positive">
                    <i class="fas fa-smile"></i>
                </div>
                <div class="stat-value positive">{{ stats.positive_percentage }}%</div>
                <div class="stat-label">Sentiments Positifs ({{ stats.positive_count }})</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon negative">
                    <i class="fas fa-frown"></i>
                </div>
                <div class="stat-value negative">{{ stats.negative_percentage }}%</div>
                <div class="stat-label">Sentiments Négatifs ({{ stats.negative_count }})</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon neutral">
                    <i class="fas fa-meh"></i>
                </div>
                <div class="stat-value neutral">{{ stats.neutral_percentage }}%</div>
                <div class="stat-label">Sentiments Neutres ({{ stats.neutral_count }})</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon info">
                    <i class="fas fa-database"></i>
                </div>
                <div class="stat-value info">{{ stats.total_analyzed }}</div>
                <div class="stat-label">Total Analysé</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="color: #f59e0b;">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <div class="stat-value" style="color: #f59e0b;">{{ stats.avg_polarity }}</div>
                <div class="stat-label">Polarité Moyenne</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="color: #06b6d4;">
                    <i class="fas fa-chart-area"></i>
                </div>
                <div class="stat-value" style="color: #06b6d4;">{{ stats.avg_subjectivity }}</div>
                <div class="stat-label">Subjectivité Moyenne</div>
            </div>
        </div>

        <!-- Insights automatiques -->
        <div class="insights-section">
            <h3><i class="fas fa-lightbulb"></i> Insights Automatiques</h3>
            <div class="insight-item">
                <div class="insight-icon">
                    <i class="fas fa-trending-up"></i>
                </div>
                <div class="insight-content">
                    <h4>Tendance Générale</h4>
                    <p>
                        {% if stats.positive_percentage > stats.negative_percentage %}
                        Les sentiments sont majoritairement positifs ({{ stats.positive_percentage }}%), indiquant une perception favorable.
                        {% elif stats.negative_percentage > stats.positive_percentage %}
                        Les sentiments négatifs dominent ({{ stats.negative_percentage }}%), suggérant des points d'amélioration.
                        {% else %}
                        Les sentiments sont équilibrés, indiquant une perception mitigée.
                        {% endif %}
                    </p>
                </div>
            </div>
            <div class="insight-item">
                <div class="insight-icon">
                    <i class="fas fa-target"></i>
                </div>
                <div class="insight-content">
                    <h4>Score de Polarité</h4>
                    <p>
                        {% if stats.avg_polarity > 0.3 %}
                        Score de polarité élevé ({{ stats.avg_polarity }}), indiquant des opinions fortement positives.
                        {% elif stats.avg_polarity < -0.3 %}
                        Score de polarité faible ({{ stats.avg_polarity }}), indiquant des opinions fortement négatives.
                        {% else %}
                        Score de polarité modéré ({{ stats.avg_polarity }}), indiquant des opinions nuancées.
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- Graphiques et visualisations -->
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-chart-pie"></i>
                    Distribution des Sentiments
                </div>
                <div class="chart-container">
                    <canvas id="sentimentPieChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <i class="fas fa-chart-bar"></i>
                    Comparaison Détaillée
                </div>
                <div class="chart-container">
                    <canvas id="sentimentBarChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <i class="fas fa-chart-line"></i>
                    Distribution de la Polarité
                </div>
                <div class="chart-container">
                    <canvas id="polarityHistogram"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <i class="fas fa-chart-area"></i>
                    Polarité vs Subjectivité
                </div>
                <div class="chart-container">
                    <canvas id="scatterChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Mots-clés -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-tags"></i>
                Analyse des Mots-clés
            </div>
            <div class="keywords-section">
                <div class="keyword-cloud positive">
                    <h4 class="positive"><i class="fas fa-thumbs-up"></i> Mots Positifs Fréquents</h4>
                    <div class="keyword-tags">
                        {% for keyword in keywords.positive %}
                        <span class="keyword-tag">{{ keyword.word }} ({{ keyword.count }})</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="keyword-cloud negative">
                    <h4 class="negative"><i class="fas fa-thumbs-down"></i> Mots Négatifs Fréquents</h4>
                    <div class="keyword-tags">
                        {% for keyword in keywords.negative %}
                        <span class="keyword-tag">{{ keyword.word }} ({{ keyword.count }})</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Tableau détaillé -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-table"></i>
                Données Détaillées ({{ results|length }} entrées)
            </div>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 50%;">Texte</th>
                            <th style="width: 15%;">Sentiment</th>
                            <th style="width: 15%;">Polarité</th>
                            <th style="width: 20%;">Subjectivité</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in results|slice:":50" %}
                        <tr>
                            <td>
                                {% if result.text|length > 100 %}
                                {{ result.text|slice:":100" }}...
                                {% else %}
                                {{ result.text }}
                                {% endif %}
                            </td>
                            <td>
                                <span class="sentiment-badge {{ result.sentiment|lower }}">
                                    {% if result.sentiment == 'Positif' %}
                                    <i class="fas fa-smile"></i>
                                    {% elif result.sentiment == 'Négatif' %}
                                    <i class="fas fa-frown"></i>
                                    {% else %}
                                    <i class="fas fa-meh"></i>
                                    {% endif %}
                                    {{ result.sentiment }}
                                </span>
                            </td>
                            <td>{{ result.polarity }}</td>
                            <td>{{ result.subjectivity }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if results|length > 50 %}
                <p style="text-align: center; margin-top: 15px; color: #64748b;">
                    <i class="fas fa-info-circle"></i>
                    Affichage des 50 premières entrées sur {{ results|length }} total
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Section d'export -->
        <div class="export-section">
            <h3><i class="fas fa-download"></i> Exporter le Rapport</h3>
            <p>Téléchargez votre analyse complète sous différents formats professionnels</p>
            <div class="export-buttons">
                <button class="btn" onclick="exportDetailedCSV()">
                    <i class="fas fa-file-csv"></i>
                    CSV Détaillé
                </button>
                <button class="btn" onclick="exportProfessionalPDF()">
                    <i class="fas fa-file-pdf"></i>
                    PDF Professionnel
                </button>
                <button class="btn" onclick="exportAllCharts()">
                    <i class="fas fa-images"></i>
                    Tous les Graphiques
                </button>
                <button class="btn btn-secondary" onclick="exportSummaryReport()">
                    <i class="fas fa-file-alt"></i>
                    Résumé Exécutif
                </button>
            </div>
        </div>
        {% endif %}

        <a href="{% url 'upload_csv' %}" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Retour à l'analyse
        </a>
    </div>

    <script>
        // Initialiser les graphiques
        {% if not error %}
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
        });

        function initializeCharts() {
            // Données pour les graphiques
            const sentimentData = {
                labels: ['Positif', 'Neutre', 'Négatif'],
                percentages: [{{ stats.positive_percentage }}, {{ stats.neutral_percentage }}, {{ stats.negative_percentage }}],
                counts: [{{ stats.positive_count }}, {{ stats.neutral_count }}, {{ stats.negative_count }}],
                colors: ['#10b981', '#3b82f6', '#ef4444']
            };

            // Graphique en secteurs
            const pieCtx = document.getElementById('sentimentPieChart').getContext('2d');
            new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: sentimentData.labels,
                    datasets: [{
                        data: sentimentData.percentages,
                        backgroundColor: sentimentData.colors,
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.raw + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Graphique en barres
            const barCtx = document.getElementById('sentimentBarChart').getContext('2d');
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: sentimentData.labels,
                    datasets: [{
                        label: 'Nombre de commentaires',
                        data: sentimentData.counts,
                        backgroundColor: sentimentData.colors,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#f1f5f9'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Histogramme de polarité
            const polarityData = [{% for result in results %}{{ result.polarity }}{% if not forloop.last %},{% endif %}{% endfor %}];
            const polarityBins = createHistogram(polarityData, 15);
            
            const polarityCtx = document.getElementById('polarityHistogram').getContext('2d');
            new Chart(polarityCtx, {
                type: 'bar',
                data: {
                    labels: polarityBins.labels,
                    datasets: [{
                        label: 'Fréquence',
                        data: polarityBins.data,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: '#667eea',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Polarité'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Fréquence'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });

            // Graphique de dispersion Polarité vs Subjectivité
            const scatterData = [
                {% for result in results %}
                {
                    x: {{ result.polarity }},
                    y: {{ result.subjectivity }},
                    sentiment: '{{ result.sentiment }}'
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            const scatterCtx = document.getElementById('scatterChart').getContext('2d');
            new Chart(scatterCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Positif',
                        data: scatterData.filter(d => d.sentiment === 'Positif'),
                        backgroundColor: 'rgba(16, 185, 129, 0.6)',
                        borderColor: '#10b981'
                    }, {
                        label: 'Neutre',
                        data: scatterData.filter(d => d.sentiment === 'Neutre'),
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: '#3b82f6'
                    }, {
                        label: 'Négatif',
                        data: scatterData.filter(d => d.sentiment === 'Négatif'),
                        backgroundColor: 'rgba(239, 68, 68, 0.6)',
                        borderColor: '#ef4444'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Polarité'
                            },
                            min: -1,
                            max: 1
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Subjectivité'
                            },
                            min: 0,
                            max: 1
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: (${context.raw.x}, ${context.raw.y})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createHistogram(data, bins) {
            const min = Math.min(...data);
            const max = Math.max(...data);
            const binSize = (max - min) / bins;
            const histogram = new Array(bins).fill(0);
            const labels = [];

            for (let i = 0; i < bins; i++) {
                labels.push((min + i * binSize).toFixed(2));
            }

            data.forEach(value => {
                const binIndex = Math.min(Math.floor((value - min) / binSize), bins - 1);
                histogram[binIndex]++;
            });

            return { labels, data: histogram };
        }

        // Fonctions d'export professionnelles
        function exportDetailedCSV() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            // En-tête du rapport
            csvContent += "RAPPORT D'ANALYSE DE SENTIMENTS\n";
            csvContent += `Généré le,${new Date().toLocaleDateString('fr-FR')}\n`;
            csvContent += `Heure,${new Date().toLocaleTimeString('fr-FR')}\n\n`;
            
            // Statistiques générales
            csvContent += "STATISTIQUES GÉNÉRALES\n";
            csvContent += "Métrique,Valeur\n";
            csvContent += `Total analysé,{{ stats.total_analyzed }}\n`;
            csvContent += `Sentiments positifs,{{ stats.positive_count }} ({{ stats.positive_percentage }}%)\n`;
            csvContent += `Sentiments négatifs,{{ stats.negative_count }} ({{ stats.negative_percentage }}%)\n`;
            csvContent += `Sentiments neutres,{{ stats.neutral_count }} ({{ stats.neutral_percentage }}%)\n`;
            csvContent += `Polarité moyenne,{{ stats.avg_polarity }}\n`;
            csvContent += `Subjectivité moyenne,{{ stats.avg_subjectivity }}\n\n`;
            
            // Données détaillées
            csvContent += "DONNÉES DÉTAILLÉES\n";
            csvContent += "ID,Texte,Sentiment,Polarité,Subjectivité\n";
            
            {% for result in results %}
            csvContent += `{{ result.id }},"{{ result.text|escapejs }}","{{ result.sentiment }}","{{ result.polarity }}","{{ result.subjectivity }}"\n`;
            {% endfor %}
            
            // Mots-clés
            csvContent += "\nMOTS-CLÉS POSITIFS\n";
            csvContent += "Mot,Fréquence\n";
            {% for keyword in keywords.positive %}
            csvContent += `"{{ keyword.word }}","{{ keyword.count }}"\n`;
            {% endfor %}
            
            csvContent += "\nMOTS-CLÉS NÉGATIFS\n";
            csvContent += "Mot,Fréquence\n";
            {% for keyword in keywords.negative %}
            csvContent += `"{{ keyword.word }}","{{ keyword.count }}"\n`;
            {% endfor %}
            
            // Télécharger
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `rapport_sentiments_detaille_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportProfessionalPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuration
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            let yPosition = 25;
            
            // En-tête professionnel
            doc.setFillColor(102, 126, 234);
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('RAPPORT D\'ANALYSE DE SENTIMENTS', pageWidth / 2, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Généré le ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')}`, pageWidth / 2, 30, { align: 'center' });
            
            yPosition = 55;
            doc.setTextColor(0, 0, 0);
            
            // Résumé exécutif
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('RÉSUMÉ EXÉCUTIF', 20, yPosition);
            yPosition += 15;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            const summary = [
                `• Total d'entrées analysées: {{ stats.total_analyzed }}`,
                `• Sentiments positifs: {{ stats.positive_count }} ({{ stats.positive_percentage }}%)`,
                `• Sentiments négatifs: {{ stats.negative_count }} ({{ stats.negative_percentage }}%)`,
                `• Sentiments neutres: {{ stats.neutral_count }} ({{ stats.neutral_percentage }}%)`,
                `• Polarité moyenne: {{ stats.avg_polarity }}`,
                `• Subjectivité moyenne: {{ stats.avg_subjectivity }}`
            ];
            
            summary.forEach(line => {
                doc.text(line, 25, yPosition);
                yPosition += 8;
            });
            
            yPosition += 15;
            
            // Insights
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('INSIGHTS CLÉS', 20, yPosition);
            yPosition += 12;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const insights = [
                {% if stats.positive_percentage > stats.negative_percentage %}
                '• Tendance générale positive avec {{ stats.positive_percentage }}% de sentiments favorables',
                {% else %}
                '• Tendance préoccupante avec {{ stats.negative_percentage }}% de sentiments défavorables',
                {% endif %}
                '• Score de polarité {{ stats.avg_polarity }} indique {% if stats.avg_polarity > 0 %}une perception globalement positive{% else %}une perception mitigée{% endif %}',
                '• Niveau de subjectivité {{ stats.avg_subjectivity }} {% if stats.avg_subjectivity > 0.5 %}élevé{% else %}modéré{% endif %}'
            ];
            
            insights.forEach(insight => {
                const lines = doc.splitTextToSize(insight, pageWidth - 50);
                lines.forEach(line => {
                    doc.text(line, 25, yPosition);
                    yPosition += 6;
                });
                yPosition += 3;
            });
            
            // Graphique principal
            yPosition += 10;
            const canvas = document.getElementById('sentimentPieChart');
            if (canvas && yPosition < pageHeight - 100) {
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('DISTRIBUTION DES SENTIMENTS', 20, yPosition);
                yPosition += 10;
                
                const imgData = canvas.toDataURL('image/png');
                doc.addImage(imgData, 'PNG', 20, yPosition, 80, 80);
                yPosition += 90;
            }
            
            // Nouvelle page pour les données
            if (yPosition > pageHeight - 50) {
                doc.addPage();
                yPosition = 25;
            }
            
            // Tableau des mots-clés
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('MOTS-CLÉS FRÉQUENTS', 20, yPosition);
            yPosition += 15;
            
            // Mots positifs
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(16, 185, 129);
            doc.text('Mots Positifs:', 20, yPosition);
            yPosition += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            let positiveWords = '';
            {% for keyword in keywords.positive %}
            positiveWords += '{{ keyword.word }} ({{ keyword.count }}){% if not forloop.last %}, {% endif %}';
            {% endfor %}
            const positiveLines = doc.splitTextToSize(positiveWords, pageWidth - 40);
            positiveLines.forEach(line => {
                doc.text(line, 25, yPosition);
                yPosition += 6;
            });
            
            yPosition += 8;
            
            // Mots négatifs
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(239, 68, 68);
            doc.text('Mots Négatifs:', 20, yPosition);
            yPosition += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            let negativeWords = '';
            {% for keyword in keywords.negative %}
            negativeWords += '{{ keyword.word }} ({{ keyword.count }}){% if not forloop.last %}, {% endif %}';
            {% endfor %}
            const negativeLines = doc.splitTextToSize(negativeWords, pageWidth - 40);
            negativeLines.forEach(line => {
                doc.text(line, 25, yPosition);
                yPosition += 6;
            });
            
            // Pied de page professionnel
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`SentimentHub - Rapport Professionnel | Page ${i}/${pageCount} | Confidentiel`, pageWidth / 2, pageHeight - 10, { align: 'center' });
            }
            
            doc.save(`rapport_sentiments_professionnel_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function exportAllCharts() {
            const charts = ['sentimentPieChart', 'sentimentBarChart', 'polarityHistogram', 'scatterChart'];
            const chartNames = ['Distribution_Sentiments', 'Comparaison_Sentiments', 'Distribution_Polarite', 'Polarite_vs_Subjectivite'];
            
            charts.forEach((chartId, index) => {
                const canvas = document.getElementById(chartId);
                if (canvas) {
                    // Créer une version haute résolution
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png', 1.0);
                    link.download = `${chartNames[index]}_${new Date().toISOString().split('T')[0]}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });
            
            // Exporter aussi le tableau des statistiques
            setTimeout(() => {
                html2canvas(document.querySelector('.stats-overview')).then(canvas => {
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    link.download = `Statistiques_Resume_${new Date().toISOString().split('T')[0]}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            }, 1000);
        }

        function exportSummaryReport() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            csvContent += "RÉSUMÉ EXÉCUTIF - ANALYSE DE SENTIMENTS\n";
            csvContent += `Date,${new Date().toLocaleDateString('fr-FR')}\n\n`;
            
            csvContent += "MÉTRIQUES CLÉS\n";
            csvContent += "Indicateur,Valeur,Pourcentage\n";
            csvContent += `Sentiments Positifs,{{ stats.positive_count }},{{ stats.positive_percentage }}%\n`;
            csvContent += `Sentiments Négatifs,{{ stats.negative_count }},{{ stats.negative_percentage }}%\n`;
            csvContent += `Sentiments Neutres,{{ stats.neutral_count }},{{ stats.neutral_percentage }}%\n`;
            csvContent += `Total Analysé,{{ stats.total_analyzed }},100%\n\n`;
            
            csvContent += "SCORES AVANCÉS\n";
            csvContent += "Métrique,Score\n";
            csvContent += `Polarité Moyenne,{{ stats.avg_polarity }}\n`;
            csvContent += `Subjectivité Moyenne,{{ stats.avg_subjectivity }}\n\n`;
            
            csvContent += "TOP 5 MOTS POSITIFS\n";
            csvContent += "Mot,Fréquence\n";
            {% for keyword in keywords.positive|slice:":5" %}
            csvContent += `{{ keyword.word }},{{ keyword.count }}\n`;
            {% endfor %}
            
            csvContent += "\nTOP 5 MOTS NÉGATIFS\n";
            csvContent += "Mot,Fréquence\n";
            {% for keyword in keywords.negative|slice:":5" %}
            csvContent += `{{ keyword.word }},{{ keyword.count }}\n`;
            {% endfor %}
            
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `resume_executif_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        {% endif %}
    </script>
    <script src="{% static 'assets/js/theme.js' %}"></script>

<script>
// Gestion du thème synchronisé avec l'accueil
document.addEventListener('DOMContentLoaded', function() {
    // Récupérer le thème sauvegardé ou utiliser le thème par défaut
    const savedTheme = localStorage.getItem('theme') || 'light-theme';
    document.body.classList.add(savedTheme);
    
    console.log('Thème appliqué:', savedTheme);
});
// Synchronisation asynchrone du thème avec les autres pages
    document.addEventListener('DOMContentLoaded', function() {
        // Fonction de synchronisation
        const syncTheme = () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const isDark = savedTheme === 'dark';
            
            if (isDark) {
                document.body.classList.remove('light-theme');
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
                document.body.classList.add('light-theme');
            }
            
            const themeSwitch = document.getElementById('theme-switch');
            if (themeSwitch) {
                themeSwitch.checked = isDark;
            }
        };
        
        // Synchronisation initiale
        syncTheme();
        
        // Écouter les changements depuis d'autres onglets
        window.addEventListener('storage', (e) => {
            if (e.key === 'theme') {
                syncTheme();
            }
        });
        
        // Synchronisation au focus de la page
        window.addEventListener('focus', syncTheme);
        window.addEventListener('pageshow', syncTheme);
    });
</script>
</body>
</html>
